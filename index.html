<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Форма Створення Рекламацій</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .loader {
            border: 5px solid #f3f3f3;
            border-top: 5px solid #3498db;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        #pdf-content {
            width: 210mm;
            padding: 15mm;
            background: white;
            color: black;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="container mx-auto max-w-4xl p-4 sm:p-6 md:p-8">
        <header class="text-center mb-8">
            <img src="https://foodline-production.com/wp-content/uploads/2021/10/3752781497_3752781497.webp" alt="Логотип Food Line Production" class="mx-auto h-20 w-auto mb-4">
            <h1 class="text-3xl font-bold text-gray-700">Створення Рекламації</h1>
            <p id="current-date" class="text-gray-500 mt-2"></p>
        </header>

        <div class="bg-white p-6 sm:p-8 rounded-2xl shadow-lg">
            <form id="complaintForm">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Ліва колонка -->
                    <div class="space-y-6">
                        <div>
                            <label for="supplier" class="block text-sm font-medium text-gray-700 mb-1">Постачальник</label>
                            <input type="text" id="supplier" name="supplier" placeholder="Назва компанії-постачальника" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" required>
                        </div>
                         <div>
                            <label for="complaint_number" class="block text-sm font-medium text-gray-700 mb-1">Номер Рекламації</label>
                            <input type="text" id="complaint_number" name="complaint_number" placeholder="Напр. 09/02" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" required>
                        </div>
                        <div>
                            <label for="product" class="block text-sm font-medium text-gray-700 mb-1">Назва Продукції / Артикул</label>
                            <input type="text" id="product" name="product" placeholder="Напр. Тара «PL» 500мл" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" required>
                        </div>
                    </div>

                    <!-- Права колонка -->
                    <div class="space-y-6">
                        <div>
                            <label for="inspector_name" class="block text-sm font-medium text-gray-700 mb-1">ПІБ Контролера якості</label>
                            <select id="inspector_name" name="inspector_name" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 bg-white" required>
                                <option value="" disabled selected>Виберіть контролера</option>
                                <option value="Огаркова Марія">Огаркова Марія</option>
                                <option value="Соботович Ліля">Соботович Ліля</option>
                            </select>
                        </div>
                        <div>
                            <label for="description" class="block text-sm font-medium text-gray-700 mb-1">Суть проблеми</label>
                            <textarea id="description" name="description" rows="5" placeholder="Детально опишіть проблему..." class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" required></textarea>
                        </div>
                    </div>
                </div>

                <!-- Завантаження фото -->
                <div class="mt-8">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Фотографії дефекту</label>
                    <div class="mt-2 flex justify-center px-6 pt-5 pb-6 border-2 border-gray-300 border-dashed rounded-lg">
                        <div class="space-y-1 text-center">
                            <svg class="mx-auto h-12 w-12 text-gray-400" stroke="currentColor" fill="none" viewBox="0 0 48 48" aria-hidden="true">
                                <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                            </svg>
                            <div class="flex text-sm text-gray-600">
                                <label for="photos" class="relative cursor-pointer bg-white rounded-md font-medium text-blue-600 hover:text-blue-500 focus-within:outline-none focus-within:ring-2 focus-within:ring-offset-2 focus-within:ring-blue-500">
                                    <span>Завантажити файли</span>
                                    <input id="photos" name="photos" type="file" class="sr-only" accept="image/*" multiple>
                                </label>
                                <p class="pl-1">або зробіть фото</p>
                            </div>
                            <p class="text-xs text-gray-500">PNG, JPG, GIF до 10MB</p>
                        </div>
                    </div>
                    <div id="image-preview" class="mt-4 grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4"></div>
                </div>

                <!-- Кнопки -->
                <div class="mt-10 flex flex-col sm:flex-row items-center justify-center gap-4">
                    <button type="button" id="generatePdfBtn" class="w-full sm:w-auto inline-flex justify-center items-center px-8 py-3 border border-transparent text-base font-medium rounded-lg shadow-sm text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition">
                        <svg class="w-5 h-5 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                        Згенерувати PDF
                    </button>
                     <button type="button" id="sendEmailBtn" class="w-full sm:w-auto inline-flex justify-center items-center px-8 py-3 border border-gray-300 text-base font-medium rounded-lg shadow-sm text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition" disabled>
                        <svg class="w-5 h-5 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path></svg>
                        Надіслати Email
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Модальне вікно для завантаження -->
    <div id="loader-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden items-center justify-center" style="z-index: 100;">
        <div class="bg-white p-8 rounded-lg shadow-xl text-center">
            <div class="loader mx-auto"></div>
            <p class="mt-4 text-gray-600">Генеруємо PDF, зачекайте...</p>
        </div>
    </div>
    
    <!-- Прихований контейнер для генерації PDF -->
    <div class="hidden">
        <div id="pdf-content">
            <style>
                /* Стилі для PDF, що імітують документ Word */
                #pdf-content {
                    font-family: 'Times New Roman', Times, serif;
                    font-size: 12pt;
                    line-height: 1.5;
                }
                .pdf-header {
                    display: flex;
                    justify-content: space-between;
                    align-items: flex-start;
                    margin-bottom: 40px;
                }
                .pdf-header .company-logo {
                    font-size: 24pt;
                    font-weight: bold;
                }
                .pdf-header .company-logo img {
                    height: 50px;
                    width: auto;
                }
                .pdf-header .recipient { text-align: right; }
                .pdf-title {
                    text-align: center;
                    font-weight: bold;
                    font-size: 16pt;
                    margin-bottom: 20px;
                }
                .pdf-section { margin-bottom: 20px; }
                .pdf-section h3 { font-weight: bold; margin-bottom: 10px; }
                .pdf-images-container {
                    display: grid;
                    grid-template-columns: 1fr 1fr;
                    gap: 10px;
                    margin-top: 20px;
                }
                 .pdf-images-container img {
                    max-width: 100%;
                    border: 1px solid #ccc;
                }
                .pdf-footer {
                    margin-top: 50px;
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                }
            </style>
            
            <div class="pdf-header">
                <div>
                    <div class="company-logo">
                         <img src="https://foodline-production.com/wp-content/uploads/2021/10/3752781497_3752781497.webp" alt="Логотип"/>
                    </div>
                    <p>ПП "ФУДЛАЙН ПРОДАКШН"</p>
                </div>
                <div class="recipient">
                    <p id="pdf-date"></p>
                    <p id="pdf-supplier" class="font-bold"></p>
                </div>
            </div>
            
            <div class="pdf-title">
                <h2 id="pdf-complaint-number"></h2>
                <p>щодо якості продукції</p>
            </div>
            
            <p>Цим листом повідомляємо про виявлення невідповідності якості в поставленій продукції — <span id="pdf-product" class="font-bold"></span>.</p>
            
            <div class="pdf-section">
                <h3>Суть проблеми:</h3>
                <p id="pdf-description"></p>
            </div>

            <div class="pdf-section">
                <p>Наявність цього дефекту порушує стабільну роботу технологічного процесу та вимагає додаткового часу та ресурсів на ручний перегляд і перебирання.</p>
            </div>

            <div class="pdf-section">
                <h3>Додатки:</h3>
                <p>До листа додаються фотоматеріали, що підтверджують наявність дефекту.</p>
                <div id="pdf-images-container" class="pdf-images-container"></div>
            </div>
            
            <div class="pdf-section">
                 <h3>Вимога:</h3>
                 <p>Просимо терміново розглянути цю рекламацію та повідомити про ваше рішення. Очікуємо на вашу відповідь та пропозиції щодо вирішення проблеми протягом 3 робочих днів.</p>
            </div>

            <div class="pdf-footer">
                <div>Контролер з якості</div>
                <div id="pdf-inspector-name"></div>
            </div>
        </div>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const form = document.getElementById('complaintForm');
            const photosInput = document.getElementById('photos');
            const imagePreview = document.getElementById('image-preview');
            const generatePdfBtn = document.getElementById('generatePdfBtn');
            const sendEmailBtn = document.getElementById('sendEmailBtn');
            const loaderModal = document.getElementById('loader-modal');

            // --- NEW LOGIC START ---

            // Function to fetch an image via a CORS proxy and convert it to a Base64 data URL.
            const getCorsImageAsBase64 = async (imageUrl) => {
                // Using a public CORS proxy to bypass cross-origin restrictions.
                const proxyUrl = `https://api.allorigins.win/raw?url=${encodeURIComponent(imageUrl)}`;
                try {
                    const response = await fetch(proxyUrl);
                    if (!response.ok) {
                        throw new Error(`Failed to fetch image through proxy. Status: ${response.status}`);
                    }
                    const blob = await response.blob();
                    return new Promise((resolve, reject) => {
                        const reader = new FileReader();
                        reader.onloadend = () => resolve(reader.result);
                        reader.onerror = reject;
                        reader.readAsDataURL(blob);
                    });
                } catch (error) {
                    console.error('CORS Image Fetch Error:', error);
                    // Return the original URL as a fallback.
                    return imageUrl;
                }
            };
            
            // Function to initialize the page, including the logo.
            const initializePage = async () => {
                // Set current date
                const currentDateElement = document.getElementById('current-date');
                const today = new Date();
                const options = { year: 'numeric', month: 'long', day: 'numeric' };
                currentDateElement.textContent = `Сьогодні: ${today.toLocaleDateString('uk-UA', options)}`;

                // Fetch and set the logo
                const originalLogoUrl = "https://foodline-production.com/wp-content/uploads/2021/10/3752781497_3752781497.webp";
                const base64LogoUrl = await getCorsImageAsBase64(originalLogoUrl);
                
                const headerLogo = document.querySelector('header img');
                const pdfLogo = document.querySelector('#pdf-content .company-logo img');

                if (headerLogo) headerLogo.src = base64LogoUrl;
                if (pdfLogo) pdfLogo.src = base64LogoUrl;
            };

            initializePage();

            // --- NEW LOGIC END ---

            let uploadedImages = [];
            let generatedPdf = null;

            photosInput.addEventListener('change', (event) => {
                imagePreview.innerHTML = '';
                uploadedImages = [];
                sendEmailBtn.disabled = true;
                generatedPdf = null;
                
                const files = event.target.files;
                if (files.length > 0) {
                    Array.from(files).forEach(file => {
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            uploadedImages.push(e.target.result);
                            const div = document.createElement('div');
                            div.className = 'relative';
                            const img = document.createElement('img');
                            img.src = e.target.result;
                            img.className = 'w-full h-auto object-cover rounded-lg shadow-md';
                            div.appendChild(img);
                            imagePreview.appendChild(div);
                        };
                        reader.readAsDataURL(file);
                    });
                }
            });

            generatePdfBtn.addEventListener('click', async () => {
                if (!form.checkValidity()) {
                    form.reportValidity();
                    return;
                }
                
                loaderModal.style.display = 'flex';
                
                // 1. Збираємо дані з форми
                const supplier = document.getElementById('supplier').value;
                const complaintNumber = document.getElementById('complaint_number').value;
                const product = document.getElementById('product').value;
                const description = document.getElementById('description').value;
                const inspectorName = document.getElementById('inspector_name').value;
                const currentDate = new Date().toLocaleDateString('uk-UA');

                // 2. Заповнюємо прихований PDF-контейнер
                document.getElementById('pdf-date').innerText = currentDate;
                document.getElementById('pdf-supplier').innerText = supplier;
                document.getElementById('pdf-complaint-number').innerText = `Рекламація № ${complaintNumber}`;
                document.getElementById('pdf-product').innerText = product;
                document.getElementById('pdf-description').innerText = description;
                document.getElementById('pdf-inspector-name').innerText = inspectorName;

                const pdfImagesContainer = document.getElementById('pdf-images-container');
                pdfImagesContainer.innerHTML = '';
                uploadedImages.forEach(src => {
                    const img = document.createElement('img');
                    img.src = src;
                    pdfImagesContainer.appendChild(img);
                });

                // 3. Генеруємо PDF
                try {
                    const { jsPDF } = window.jspdf;
                    const pdfContentElement = document.getElementById('pdf-content');

                    const canvas = await html2canvas(pdfContentElement, {
                        scale: 2,
                        useCORS: true 
                    });
                    
                    const imgData = canvas.toDataURL('image/png');
                    const pdf = new jsPDF('p', 'mm', 'a4');
                    const pdfWidth = pdf.internal.pageSize.getWidth();
                    const pdfHeight = pdf.internal.pageSize.getHeight();
                    
                    const canvasWidth = canvas.width;
                    const canvasHeight = canvas.height;
                    const ratio = canvasHeight / canvasWidth;
                    const imgHeight = pdfWidth * ratio;
                    
                    let heightLeft = imgHeight;
                    let position = 0;

                    pdf.addImage(imgData, 'PNG', 0, position, pdfWidth, imgHeight);
                    heightLeft -= pdfHeight;

                    while (heightLeft > 0) {
                        position = position - pdfHeight;
                        pdf.addPage();
                        pdf.addImage(imgData, 'PNG', 0, position, pdfWidth, imgHeight);
                        heightLeft -= pdfHeight;
                    }
                    
                    const fileName = `Reklamatsiya_${complaintNumber.replace('/', '-')}_${supplier}.pdf`;
                    pdf.save(fileName);
                    
                    generatedPdf = pdf.output('blob');
                    sendEmailBtn.disabled = false;
                } catch (error) {
                    console.error("Помилка при генерації PDF:", error);
                    alert("Не вдалося створити PDF. Спробуйте ще раз.");
                } finally {
                     loaderModal.style.display = 'none';
                }

            });
            
            sendEmailBtn.addEventListener('click', () => {
                if (!generatedPdf) {
                    alert("Спочатку згенеруйте PDF-файл.");
                    return;
                }

                const complaintNumber = document.getElementById('complaint_number').value;
                const product = document.getElementById('product').value;

                const subject = `Рекламація № ${complaintNumber} щодо продукції: ${product}`;
                const body = `Доброго дня.\n\nНадсилаємо вам рекламацію щодо якості поставленої продукції.\nДеталі в прикріпленому файлі.\n\nЗ повагою,\n${document.getElementById('inspector_name').value}\nПП "ФУДЛАЙН ПРОДАКШН"`;
                
                const mailtoLink = `mailto:?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
                
                alert("Зараз відкриється ваш поштовий клієнт. Будь ласка, вкажіть адресу отримувача та вручну прикріпіть до листа щойно завантажений PDF-файл.");

                window.location.href = mailtoLink;
            });
        });
    </script>
</body>
</html>

