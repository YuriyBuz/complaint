<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Форма Створення Рекламацій</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        
        /* Стилі для друку: приховуємо форму та показуємо лише документ */
        @media print {
            /* ВАЖЛИВО: Встановлюємо портретну орієнтацію сторінки */
            @page {
                size: A4 portrait;
            }
            
            body { 
                background: none; 
                color: #000;
                /* Забезпечуємо відображення фонових зображень та кольорів */
                -webkit-print-color-adjust: exact; 
                color-adjust: exact;
            }
            #complaint-form-container, #preview-btn { display: none; }
            #pdf-document-container { 
                display: block !important; 
                width: 100%;
                margin: 0;
                padding: 0;
            }
            /* Імітуємо розмір листа А4 для кращого візуального сприйняття */
            .document-page {
                width: 210mm; /* A4 width (portrait) */
                min-height: 297mm; /* A4 height (portrait) */
                margin: 0 auto;
                padding: 20mm;
                box-shadow: none;
            }
        }

        /* Стилі для модальних вікон */
        .modal-display-flex { display: flex; align-items: center; justify-content: center; }
        #pdf-document-container { display: none; }
        
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div id="complaint-form-container" class="container mx-auto max-w-4xl p-4 sm:p-6 md:p-8">
        <header class="text-center mb-8">
            <h1 class="text-3xl font-bold text-gray-700">Створення Рекламації</h1>
            <p id="current-date" class="text-gray-500 mt-2"></p>
        </header>

        <div class="bg-white p-6 sm:p-8 rounded-2xl shadow-xl border border-gray-200">
            <form id="complaintForm">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="space-y-6">
                        <div>
                            <label for="supplier" class="block text-sm font-medium text-gray-700 mb-1">Постачальник</label>
                            <input type="text" id="supplier" name="supplier" placeholder="Назва компанії-постачальника" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150" required>
                        </div>
                         <div>
                            <label for="complaint_number" class="block text-sm font-medium text-gray-700 mb-1">Номер Рекламації</label>
                            <input type="text" id="complaint_number" name="complaint_number" placeholder="Напр. 09/02" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150" required>
                        </div>
                        <div>
                            <label for="product" class="block text-sm font-medium text-gray-700 mb-1">Назва Продукції / Артикул</label>
                            <input type="text" id="product" name="product" placeholder="Напр. Тара «PL» 500мл" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150" required>
                        </div>
                    </div>

                    <div class="space-y-6">
                        <div>
                            <label for="inspector_name" class="block text-sm font-medium text-gray-700 mb-1">ПІБ Контролера якості</label>
                            <select id="inspector_name" name="inspector_name" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 bg-white transition duration-150" required>
                                <option value="" disabled selected>Виберіть контролера</option>
                                <option value="Огаркова Марія">Огаркова Марія</option>
                                <option value="Соботович Ліля">Соботович Ліля</option>
                            </select>
                        </div>
                        <div>
                            <label for="description" class="block text-sm font-medium text-gray-700 mb-1">Суть проблеми</label>
                            <textarea id="description" name="description" rows="5" placeholder="Детально опишіть проблему..." class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150" required></textarea>
                        </div>
                    </div>
                </div>

                <div class="mt-8">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Фотографії дефекту</label>
                    <div class="mt-2 flex justify-center px-6 pt-5 pb-6 border-2 border-gray-300 border-dashed rounded-lg hover:border-blue-400 transition">
                        <div class="space-y-1 text-center">
                            <svg class="mx-auto h-12 w-12 text-gray-400" stroke="currentColor" fill="none" viewBox="0 0 48 48" aria-hidden="true"><path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3-3a4 4 0 00-5.656 0L28 28M8 32l9-9a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" /></svg>
                            <div class="flex text-sm text-gray-600">
                                <label for="photos" class="relative cursor-pointer bg-white rounded-md font-medium text-blue-600 hover:text-blue-500 focus-within:outline-none focus-within:ring-2 focus-within:ring-offset-2 focus-within:ring-blue-500">
                                    <span>Завантажити файли</span>
                                    <input id="photos" name="photos" type="file" class="sr-only" accept="image/*" multiple>
                                </label>
                                <p class="pl-1">або зробіть фото</p>
                            </div>
                            <p class="text-xs text-gray-500">PNG, JPG, до 10MB (автоматично стискаються)</p>
                        </div>
                    </div>
                    <!-- Блок для попереднього перегляду зображень -->
                    <div id="image-preview" class="mt-4 grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4"></div>
                </div>

                <div class="mt-10 flex flex-col sm:flex-row items-center justify-center gap-4">
                    <button type="button" id="generatePdfBtn" class="w-full sm:w-auto inline-flex justify-center items-center px-8 py-3 border border-transparent text-base font-medium rounded-lg shadow-lg text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition duration-150">
                        <svg class="w-5 h-5 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                        Згенерувати PDF (Друк)
                    </button>
                    <button type="button" id="preview-btn" class="w-full sm:w-auto inline-flex justify-center items-center px-8 py-3 border border-gray-300 text-base font-medium rounded-lg shadow-lg text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-150">
                        <svg class="w-5 h-5 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.477 0 8.268 2.943 9.542 7-1.274 4.057-5.065 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/></svg>
                        Попередній перегляд
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Контейнер для документа (показується тільки при друку або в режимі попереднього перегляду) -->
    <div id="pdf-document-container" class="p-4 sm:p-8">
        <div id="document-content" class="document-page bg-white mx-auto shadow-2xl transition duration-300">
            <!-- Динамічний вміст документа буде тут -->
        </div>
    </div>
    
    <!-- Модальне вікно для повідомлень (замість alert) -->
    <div id="message-modal" class="fixed inset-0 bg-gray-900 bg-opacity-40 h-full w-full hidden items-center justify-center z-50 modal-display-flex">
        <div class="bg-white p-6 rounded-xl shadow-2xl max-w-sm w-full transform transition-all scale-100 opacity-100 border-t-4 border-blue-500">
            <h3 id="message-title" class="text-xl font-bold text-gray-900 mb-3">Повідомлення</h3>
            <p id="message-content" class="text-sm text-gray-700 mb-6 leading-relaxed"></p>
            <button id="message-ok-btn" class="w-full inline-flex justify-center rounded-lg border border-transparent px-4 py-2 bg-blue-600 text-base font-medium text-white hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition duration-150">
                Зрозуміло
            </button>
        </div>
    </div>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // КОНСТАНТИ
            const form = document.getElementById('complaintForm');
            const photosInput = document.getElementById('photos');
            const imagePreview = document.getElementById('image-preview');
            const generatePdfBtn = document.getElementById('generatePdfBtn');
            const previewBtn = document.getElementById('preview-btn');
            const documentContainer = document.getElementById('pdf-document-container');
            const documentContent = document.getElementById('document-content');

            // Логотип (змінено на більш простий Base64)
            const LOGO_BASE64 = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEAAAABACAYAAADmB2rzAAAACXBIWXMAAAsTAAALEwEAmpwYAAABH0lEQVR42u3bQQuDMBCG4b2v/E7Fv0K96kO4rQ+oH6CgoJ/Q/xYI+38kI5mQzGgmk9HkXn/4Q4B9w823336JAB/jWc978zN6Qc9rV3B5wN+z/N//c0b5f1sA7i6gT5561j9A77u8F1LzD4XfT78TfM+C7y5g2X8Bve8yH3P13wR773l+v88p/3UAdg0f+X7jI5oH3n+O1X8x0P8W8P937v9TBrjT42d3m5tW2C9g+g6g/70yW/N3Avz11rP+ATqY8f/Q70vC4A9Q/wG465J/1b/4B+h26s+sP8A+0b9hAAvq/QyA6xJ/bOADg9fB9+8F1H+A/nfrL8V/A2z/pQW+V0b4gCeg/wCYNf9lB/07h+Jv/kX3c+5/G+b+e7D/77mP/8YBeD397gMAB5zJgnf+Yv3XAPy6+8/f4gH974D+W8T9e8z9X6D/f0eDfwU6Xj0+V/9/A+j/v9Y2D+/7b+j/P2U947937n8b5v57sP/vub/95f/g/0/Wb/h7AABvjU0mk9FoNAG2fN+W/i+t8f5DOP6wGZ51GZ4BAAAAAElFTkSuQmCC';

            // --- Утиліти для модальних вікон ---

            const showMessageModal = (title, message, callback = null) => {
                const modal = document.getElementById('message-modal');
                const titleEl = modal.querySelector('#message-title');
                const contentEl = modal.querySelector('#message-content');
                const okBtn = modal.querySelector('#message-ok-btn');

                titleEl.textContent = title;
                contentEl.innerHTML = message;
                modal.classList.remove('hidden');
                modal.classList.add('modal-display-flex');

                const handler = () => {
                    modal.classList.add('hidden');
                    modal.classList.remove('modal-display-flex');
                    okBtn.removeEventListener('click', handler);
                    if (callback) callback();
                };
                
                okBtn.addEventListener('click', handler);
            };

            // Функція зміни розміру та конвертації зображення в Base64
            const resizeImage = (file, maxWidth = 800) => {
                return new Promise((resolve, reject) => {
                    if (!file.type.startsWith('image/')) {
                        reject(new Error("Файл не є зображенням."));
                        return;
                    }

                    const reader = new FileReader();
                    reader.readAsDataURL(file);
                    reader.onload = (event) => {
                        const img = new Image();
                        img.src = event.target.result;
                        img.onload = () => {
                            const canvas = document.createElement('canvas');
                            const { width, height } = img;
                            
                            let newWidth = width;
                            let newHeight = height;

                            if (width > maxWidth) {
                                newWidth = maxWidth;
                                newHeight = (height * maxWidth) / width;
                            }
                            
                            canvas.width = newWidth;
                            canvas.height = newHeight;
                            
                            const ctx = canvas.getContext('2d');
                            ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                            
                            // Повертаємо стиснуте зображення у форматі JPEG
                            resolve({
                                dataUrl: canvas.toDataURL('image/jpeg', 0.85),
                                ratio: canvas.width / canvas.height
                            });
                        };
                        img.onerror = () => reject(new Error("Помилка завантаження зображення."));
                    };
                    reader.onerror = () => reject(new Error("Помилка читання файлу."));
                });
            };

            let uploadedImages = [];

            // --- Ініціалізація та Логіка ---

            const initializePage = () => {
                document.getElementById('current-date').textContent = `Сьогодні: ${new Date().toLocaleDateString('uk-UA', { year: 'numeric', month: 'long', day: 'numeric' })}`;
            };

            // ГЕНЕРАЦІЯ HTML-КОНТЕНТУ ДЛЯ ДРУКУ
            const generateDocumentHTML = (data, images) => {
                const currentDate = new Date().toLocaleDateString('uk-UA', { year: 'numeric', month: 'long', day: 'numeric' });
                
                let imageHtml = '';
                if (images.length > 0) {
                    imageHtml = `
                        <h3 class="text-lg font-bold mt-8 mb-4 text-gray-800 border-b pb-1">Додані фотографії</h3>
                        <div class="grid grid-cols-2 gap-4">
                            ${images.map((img, index) => `
                                <div class="break-inside-avoid mb-4">
                                    <img src="${img.dataUrl}" alt="Фото дефекту ${index + 1}" style="width: 100%; height: auto; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                                    <p class="text-xs text-center mt-1 text-gray-600">Фото ${index + 1}</p>
                                </div>
                            `).join('')}
                        </div>
                    `;
                }

                return `
                    <!-- Хедер документа -->
                    <div class="flex justify-between items-start mb-10">
                        <img src="${LOGO_BASE64}" alt="Логотип" class="w-20 h-auto">
                        <div class="text-sm text-right">
                            <p class="font-bold">Отримувач: ${data.supplier}</p>
                            <p class="mt-1">Дата: ${currentDate}</p>
                        </div>
                    </div>

                    <!-- Заголовок -->
                    <div class="text-center mb-8">
                        <h1 class="text-2xl font-extrabold text-gray-900 mb-1">Рекламація № ${data.complaintNumber}</h1>
                        <p class="text-lg text-gray-600">щодо якості продукції</p>
                    </div>

                    <!-- Вступ -->
                    <p class="mb-6 leading-relaxed">
                        Цим листом повідомляємо про виявлення невідповідності якості в поставленій продукції — 
                        <span class="font-bold">${data.product}</span>.
                    </p>

                    <!-- Суть проблеми -->
                    <div class="mb-6">
                        <h3 class="text-lg font-bold mb-2 text-gray-800">Суть проблеми:</h3>
                        <p class="leading-relaxed">${data.description}</p>
                    </div>

                    <!-- Пункти -->
                    <div class="space-y-4 mb-8">
                        <div>
                            <p class="font-bold text-gray-800">Вплив:</p>
                            <p class="ml-4 text-gray-700">Наявність цього дефекту порушує стабільну роботу технологічного процесу та вимагає додаткового часу та ресурсів на ручний перегляд і перебирання.</p>
                        </div>
                        <div>
                            <p class="font-bold text-gray-800">Вимога:</p>
                            <p class="ml-4 text-gray-700">Просимо терміново розглянути цю рекламацію та повідомити про ваше рішення. Очікуємо на вашу відповідь та пропозиції щодо вирішення проблеми протягом 3 робочих днів.</p>
                        </div>
                        <div>
                            <p class="font-bold text-gray-800">Додатки:</p>
                            <p class="ml-4 text-gray-700">До листа додаються фотоматеріали, що підтверджують наявність дефекту.</p>
                        </div>
                    </div>
                    
                    <!-- Фотографії -->
                    ${imageHtml}

                    <!-- Підпис -->
                    <div class="mt-16 pt-8 flex justify-between items-end border-t border-gray-300">
                        <div class="text-base">
                            <p>Контролер з якості</p>
                        </div>
                        <div class="text-lg font-bold">
                            <p>${data.inspectorName}</p>
                        </div>
                    </div>
                `;
            };

            // Оновлення попереднього перегляду при зміні форми
            form.addEventListener('input', () => {
                // Збираємо дані форми
                const data = {
                    supplier: document.getElementById('supplier').value,
                    complaintNumber: document.getElementById('complaint_number').value,
                    product: document.getElementById('product').value,
                    description: document.getElementById('description').value,
                    inspectorName: document.getElementById('inspector_name').value
                };
                // Генеруємо HTML і оновлюємо контейнер
                documentContent.innerHTML = generateDocumentHTML(data, uploadedImages);
            });

            photosInput.addEventListener('change', async (event) => {
                imagePreview.innerHTML = '';
                uploadedImages = [];
                
                const files = event.target.files;
                if (files.length > 0) {
                    
                    try {
                        // Обробка та стиснення зображень
                        const resizePromises = Array.from(files).map(file => resizeImage(file));
                        uploadedImages = await Promise.all(resizePromises);
                        
                        // Відображення попереднього перегляду
                        uploadedImages.forEach((imgData, index) => {
                            const container = document.createElement('div');
                            container.className = 'relative group';
                            
                            const img = document.createElement('img');
                            img.src = imgData.dataUrl;
                            img.className = 'w-full h-32 object-cover rounded-lg shadow-md border border-gray-200';
                            
                            const caption = document.createElement('p');
                            caption.textContent = `Фото ${index + 1}`;
                            caption.className = 'absolute bottom-0 left-0 right-0 bg-black bg-opacity-50 text-white text-xs text-center py-1 rounded-b-lg opacity-0 group-hover:opacity-100 transition-opacity';

                            container.appendChild(img);
                            container.appendChild(caption);
                            imagePreview.appendChild(container);
                        });

                    } catch (error) {
                        console.error("Помилка обробки зображень:", error);
                        showMessageModal('Помилка обробки', `Не вдалося обробити зображення: ${error.message}`);
                    }
                }
                // Оновлюємо HTML-документ після завантаження зображень
                form.dispatchEvent(new Event('input'));
            });

            // Кнопка ГЕНЕРАЦІЇ (ДРУКУ) PDF
            generatePdfBtn.addEventListener('click', () => {
                if (!form.checkValidity()) {
                    form.reportValidity();
                    return;
                }
                
                // 1. Оновлюємо вміст документа перед друком
                form.dispatchEvent(new Event('input'));

                // 2. Виводимо діалогове вікно друку
                window.print();
                
                // 3. Відкладаємо показ модального вікна, щоб він не заважав вікну друку.
                // Затримка 100 мс дає браузеру час, щоб відкрити нативне вікно.
                setTimeout(() => {
                    showMessageModal(
                        'Документ готовий до друку!',
                        'У вікні, що з\'явилося, виберіть **"Зберегти як PDF"** або **"Microsoft Print to PDF"** як принтер, щоб створити PDF-файл з коректною кирилицею.'
                    );
                }, 100);
            });
            
            // Кнопка попереднього перегляду
            previewBtn.addEventListener('click', () => {
                if (!form.checkValidity()) {
                    form.reportValidity();
                    showMessageModal("Помилка", "Будь ласка, заповніть всі обов'язкові поля форми перед переглядом.");
                    return;
                }
                
                // Оновлюємо вміст і перемикаємо відображення
                form.dispatchEvent(new Event('input')); 
                
                const isHidden = documentContainer.style.display === 'none' || documentContainer.style.display === '';
                documentContainer.style.display = isHidden ? 'block' : 'none';
                
                previewBtn.innerHTML = isHidden 
                    ? '<svg class="w-5 h-5 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172A4 4 0 0010.172 6.172L1.75 14.594A4 4 0 107.121 20H18a4 4 0 000-8h-4.172z"/></svg> Повернутися до форми'
                    : '<svg class="w-5 h-5 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.477 0 8.268 2.943 9.542 7-1.274 4.057-5.065 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/></svg> Попередній перегляд';
                
                document.getElementById('complaint-form-container').style.display = isHidden ? 'none' : 'block';
            });


            initializePage();
        });
    </script>
</body>
</html>
